name: Build and test wakepy üèóÔ∏èüß™

on:
  # Allows for manually starting tests
  workflow_dispatch:
  # Make this a reusable workflow
  workflow_call:
  # Triggers when pull request is created and when pushing to PR
  pull_request:


env:
  PYTHON_VERSION: '3.14' # List of available versions: https://github.com/actions/python-versions/blob/main/versions-manifest.json

jobs:
  build-python-distributions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Get history and tags for setuptools-scm
        run: |
          git fetch --prune --unshallow
          git fetch --depth=1 origin +refs/tags/*:refs/tags/*
          git describe --tags
          git describe --tags $(git rev-list --tags --max-count=1)

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 #v7.1.6
        with:
          version: "0.9.18"
          python-version: ${{ env.PYTHON_VERSION }}
          enable-cache: true

      - name: Build python distributions
        run: uv build
      - uses: actions/upload-artifact@v4
        with:
          name: wakepy-python-packages
          path: ./dist/*.*
          if-no-files-found: error
          retention-days: 1

  test-supported-python-versions:
    name: Tests (${{ matrix.python-version }} on ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: build-python-distributions
    strategy:
      matrix:
        os: [ubuntu-latest]
        # To check available versions, see: uv python list --all-arches --all-platforms
        # To check available runners, see: https://github.com/actions/runner-images
        # All supported python versions on linux
        python-version: ["3.7", "3.8", "3.9", "3.10", "3.11", "3.12", "3.13", "3.14", "3.14t", "3.15", "3.15t", "pypy3.8", "pypy3.11"]
        include:
          # Oldest supported python on MacOS runners
          - python-version: "3.7"
            os: macos-15-intel # CPython 3.7 is only available for x86_64
          # Newest supported python on MacOS
          - python-version: "3.15"
            os: macos-latest
          # Newest supported python on MacOS, free-threaded
          - python-version: "3.15t"
            os: macos-latest
          # Oldest supported python on Windows
          - python-version: "3.7"
            os: windows-latest
          # Newest supported python on Windows
          - python-version: "3.15"
            os: windows-latest
          # Newest supported python on Windows, free-threaded
          - python-version: "3.15t"
            os: windows-latest
          # PyPy on Windows
          - python-version: "pypy3.11"
            os: windows-latest
      fail-fast: false

    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 #v7.1.6
        with:
          version: "0.9.18"
          python-version: ${{ matrix.python-version }}
          enable-cache: true

      - name: Install legacy python version
        if: matrix.python-version == '3.7'
        # Python 3.7 was dropped in uv 0.7.x
        # See: https://github.com/astral-sh/uv/blob/main/changelogs/0.7.x.md
        # Hacky workaround from https://github.com/astral-sh/uv/pull/13022#issuecomment-2848649176
        #
        # NOTE: This will emit some [tool.uv.dependency-groups] warnings. That's expected and ok.
        run: |
          uvx uv@0.6.17 python list --all-arches --all-platforms
          uvx uv@0.6.17 python install 3.7
        env:
          # Needs to be any valid version to make uvx work. That version of python must
          # be available on the used uv version (installed above)
          UV_PYTHON: ${{ env.PYTHON_VERSION }}

      - name: Show python version and GIL status
        run: |
          uv run --no-project python --version --version
          uv run --no-project python -c "import sys; is_enabled = sys._is_gil_enabled() if hasattr(sys, '_is_gil_enabled') else '?'; print('sys._is_gil_enabled:', is_enabled)"
          uv run --no-project python -c "import sysconfig; print('Py_GIL_DISABLED:', sysconfig.get_config_var('Py_GIL_DISABLED'))"

      - name: Download built wheel
        uses: actions/download-artifact@v4
        with:
          name: wakepy-python-packages
          path: ./dist/

      - name: Install wakepy from wheel
        shell: bash # needs bash shell to expand glob
        run: |
          uv venv
          uv pip list
          uv pip install ./dist/wakepy-*.whl
          uv pip list

      - name: Install test dependencies
        run: |
          uv pip install --group test
          uv pip list

      - name: Run tests
        # "python -m xxx" used instead of direct "xxx" to avoid "Needs to be any valid version to make uvx work" with CPython 3.7 on Windows.
        run: |
          uv run --no-project python -m pytest -W error --cov-branch --cov wakepy --cov-fail-under=100

      - name: Show uncovered lines
        if: success() || failure()
        run: uv run --no-project python -m coverage report --show-missing --skip-covered

      - name: Run mypy on src only
        run: |
          uv pip install --group mypy
          uv run --no-project python --version --version
          uv run --no-project python -m mypy src/wakepy/

  check-code:
    # Reasons this is a separate job
    # (1) This runs fast. Different from the other steps, this does not require
    #     the build step. It gives instant feedback if code has minor problems.
    # (2) This runs ruff + mypy. For most of there it is enough to run
    #     it once with one version of python and one OS.
    # (3) This runs more comprehensive mypy check as it checks also the tests
    #     whereas the mypy check in test jobs only runs mypy on the /src
    #     folder. Note that some mypy check results depend on the used version
    #     of python and therefore it needs also a separate step (with multiple
    #     versions of python)
    name: Check code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 #v7.1.6
        with:
          version: "0.9.18"
          python-version: ${{ env.PYTHON_VERSION }}
          enable-cache: true

      - name: Install the project
        run: uv sync --locked --group check
      - name: Ruff linter check
        run: uv run ruff check --no-fix src/wakepy tests/
      - name: Ruff format check
        run: uv run ruff format --check src/wakepy tests/
      - name: Mypy check
        run: uv run mypy src/wakepy tests/

  test-build-docs:
    name: Test building docs
    runs-on: ubuntu-latest
    needs: build-python-distributions # Does not make sense to try to build docs if build failed
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 #v7.1.6
        with:
          version: "0.9.18"
          python-version: ${{ env.PYTHON_VERSION }}
          enable-cache: true

      - name: Install docs dependencies
        run: |
          uv sync --locked --group docs
          uv pip list

      - name: Test building docs
        # -E: Don‚Äôt use a saved environment (the structure caching all cross-references),
        #     but rebuild it completely.
        # -W: Turn warnings into errors. This means that the build stops at the first
        #     warning and sphinx-build exits with exit status 1.
        run: |
          uv run sphinx-build -EW docs/source/ docs/build

  github-actions-static-analysis:
    name: zizmor üåà (GitHub Actions static analysis)
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Run zizmor üåà
        uses: zizmorcore/zizmor-action@e639db99335bc9038abc0e066dfcd72e23d26fb4 # v0.3.0


# Cancel in-progress jobs/runs for the same workflow; if you push to same
# pull request twice, the previous workflow should be canceled.
# From: https://docs.github.com/en/actions/using-jobs/using-concurrency#example-only-cancel-in-progress-jobs-or-runs-for-the-current-workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


# See: https://docs.github.com/en/actions/using-jobs/assigning-permissions-to-jobs
permissions:
    actions: write
    checks: none
    contents: read
    deployments: none
    id-token: none
    issues: none
    discussions: none
    packages: none
    pages: none
    pull-requests: none
    repository-projects: none
    security-events: read
    statuses: none
